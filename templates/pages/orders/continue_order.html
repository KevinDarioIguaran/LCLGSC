{% extends "layouts/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Resumen del pedido{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'styles/pages/orders/order.css' %}">
{% endblock %}

{% block content %}
{% include "components/navbar/navbar.html" %}

<div class="order-container">
    <h2 class="order-title">Resumen del pedido</h2>

    {% if items %}
        <div class="order-table-wrapper">
            <table class="order-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio unitario</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>${{ item.product.price|floatformat:0|intcomma }}</td>
                            <td>${{ item.total|floatformat:0|intcomma }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="order-total-label">Total:</td>
                        <td class="order-total-amount" id="order-total-amount" data-base="{{ total|floatformat:0 }}">
                            ${{ total|floatformat:0|intcomma }}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    {% endif %}

    <br>

    <div class="order-user-financials">
        <p>Crédito disponible: <strong id="credit-available">${{ credit|floatformat:0|intcomma }}</strong></p><br>
        <p>Envío: <strong id="shipping-cost">$0</strong></p><br>
        <p>Crédito restante si realiza el pedido: <strong id="remaining-credit">${{ credit|floatformat:0|intcomma }}</strong></p>
        <p id="credit-warning" class="order-warning2-title order-warning-title">
            <strong>No tiene crédito suficiente para este pedido.</strong>
        </p>
    </div>

    <br>

    {% if can_continue %}
        <form id="order-confirm-form" class="order-confirm-form" method="POST" action="{% url 'orders:order_create' %}">
            {% csrf_token %}
            <select name="school_address" id="school_address" required>
                <option value="">--- Dirección ---</option>
                {% for value, label in school_address_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
            <button type="submit" id="confirm-btn" class="order-confirm-btn" disabled>Confirmar pedido</button>
        </form>
        <div id="order-response" class="order-response"></div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const schoolSelect = document.getElementById('school_address');
    const shippingCostElement = document.getElementById('shipping-cost');
    const orderTotalElement = document.getElementById('order-total-amount');
    const remainingCreditElement = document.getElementById('remaining-credit');
    const creditAvailableElement = document.getElementById('credit-available');
    const creditWarningElement = document.getElementById('credit-warning');
    const confirmBtn = document.getElementById('confirm-btn');

    const baseTotal = parseFloat(orderTotalElement.dataset.base) || 0;
    const creditAvailable = parseFloat(
        creditAvailableElement.textContent.replace(/[\s\$,]/g, '')
    ) || 0;

    function updateVisuals() {
        const address = schoolSelect.value;
        let shipping = 0;

        if (address && address.toLowerCase() !== 'cooperative') {
            shipping = 300; 
        }

        const visualTotal = baseTotal + shipping;
        const remainingCredit = creditAvailable - visualTotal;

        shippingCostElement.textContent = `$${shipping.toLocaleString()}`;
        orderTotalElement.textContent = `$${visualTotal.toLocaleString()}`;
        remainingCreditElement.textContent = `$${remainingCredit.toLocaleString()}`;

        if (remainingCredit < 0) {
            creditWarningElement.style.display = 'block';
            confirmBtn.disabled = true;
        } else {
            creditWarningElement.style.display = 'none';
            confirmBtn.disabled = !address;
        }
    }

    schoolSelect.addEventListener('change', updateVisuals);

    updateVisuals(); 
});
</script>
{% endblock %}
